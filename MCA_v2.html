<!DOCTYPE html>
<html lang="ko" class="scroll-smooth">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Moonwave MCA</title>
    <meta name="description" content="ë¶„í• ë§¤ìˆ˜ ì „ëµ ê´€ë¦¬ ë„êµ¬ - Moonwave MCA">
    <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#0f0f0f" media="(prefers-color-scheme: dark)">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'system-ui', '-apple-system', 'sans-serif'] },
                    colors: {
                        background: 'var(--background)',
                        foreground: 'var(--foreground)',
                        card: { DEFAULT: 'var(--card)', foreground: 'var(--card-foreground)' },
                        primary: { DEFAULT: 'var(--primary)', foreground: 'var(--primary-foreground)' },
                        secondary: { DEFAULT: 'var(--secondary)', foreground: 'var(--secondary-foreground)' },
                        muted: { DEFAULT: 'var(--muted)', foreground: 'var(--muted-foreground)' },
                        accent: { DEFAULT: 'var(--accent)', foreground: 'var(--accent-foreground)' },
                        destructive: { DEFAULT: 'var(--destructive)', foreground: 'var(--destructive-foreground)' },
                        border: 'var(--border)',
                        input: 'var(--input)',
                        ring: 'var(--ring)',
                        success: { DEFAULT: 'var(--success)', foreground: 'var(--success-foreground)' },
                        warning: { DEFAULT: 'var(--warning)', foreground: 'var(--warning-foreground)' },
                    },
                    borderRadius: {
                        lg: 'var(--radius)',
                        md: 'calc(var(--radius) - 2px)',
                        sm: 'calc(var(--radius) - 4px)',
                    },
                    keyframes: {
                        'fade-in': { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
                        'slide-up': { '0%': { opacity: '0', transform: 'translateY(20px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
                        'pulse-soft': { '0%, 100%': { opacity: '1' }, '50%': { opacity: '0.7' } },
                    },
                    animation: {
                        'fade-in': 'fade-in 0.3s ease-out',
                        'slide-up': 'slide-up 0.4s ease-out',
                        'pulse-soft': 'pulse-soft 2s ease-in-out infinite',
                    },
                }
            }
        }
    </script>
    <style>
        :root {
            --background: #ffffff;
            --foreground: #0f172a;
            --card: #ffffff;
            --card-foreground: #0f172a;
            --primary: #2563eb;
            --primary-foreground: #ffffff;
            --secondary: #f1f5f9;
            --secondary-foreground: #475569;
            --muted: #f1f5f9;
            --muted-foreground: #64748b;
            --accent: #dbeafe;
            --accent-foreground: #1e40af;
            --destructive: #ef4444;
            --destructive-foreground: #ffffff;
            --success: #22c55e;
            --success-foreground: #ffffff;
            --warning: #f59e0b;
            --warning-foreground: #ffffff;
            --border: #e2e8f0;
            --input: #e2e8f0;
            --ring: #2563eb;
            --radius: 0.75rem;
        }

        .dark {
            --background: #0f0f0f;
            --foreground: #fafafa;
            --card: #171717;
            --card-foreground: #fafafa;
            --primary: #3b82f6;
            --primary-foreground: #ffffff;
            --secondary: #262626;
            --secondary-foreground: #a1a1aa;
            --muted: #262626;
            --muted-foreground: #a1a1aa;
            --accent: #1e3a5f;
            --accent-foreground: #93c5fd;
            --destructive: #dc2626;
            --destructive-foreground: #fafafa;
            --success: #16a34a;
            --success-foreground: #fafafa;
            --warning: #d97706;
            --warning-foreground: #fafafa;
            --border: #262626;
            --input: #262626;
            --ring: #3b82f6;
        }

        * {
            border-color: var(--border);
        }

        body {
            background-color: var(--background);
            color: var(--foreground);
            -webkit-tap-highlight-color: transparent;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .card {
            background: var(--card);
            color: var(--card-foreground);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
        }

        .dark .card {
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.3), 0 1px 2px -1px rgb(0 0 0 / 0.3);
        }

        input,
        button {
            touch-action: manipulation;
        }

        .checkbox-wrapper {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
        }

        input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
            accent-color: var(--primary);
        }

        input.order-checkbox {
            accent-color: var(--warning);
        }

        input.exec-checkbox {
            accent-color: var(--success);
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .param-label {
            height: 1.25rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .tab-active {
            background-color: var(--background);
            color: var(--foreground);
            box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        }

        .tab-inactive {
            background-color: transparent;
            color: var(--muted-foreground);
        }

        .tab-inactive:hover {
            color: var(--foreground);
        }

        .btn-primary {
            background-color: var(--primary);
            color: var(--primary-foreground);
            transition: all 0.2s ease;
        }

        .btn-primary:hover {
            filter: brightness(1.1);
        }

        .btn-primary:active {
            filter: brightness(0.95);
        }

        .input-field {
            background-color: var(--background);
            border: 1px solid var(--border);
            border-radius: calc(var(--radius) - 2px);
            transition: all 0.2s ease;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--ring);
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2);
        }

        .dark .input-field:focus {
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
        }

        .badge {
            display: inline-flex;
            align-items: center;
            border-radius: 9999px;
            padding: 0.125rem 0.625rem;
            font-size: 0.625rem;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .glass {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }

        .dark .glass {
            background: rgba(15, 15, 15, 0.8);
        }
    </style>
    <script>
        // ë‹¤í¬ ëª¨ë“œ ì´ˆê¸°í™” (FOUC ë°©ì§€)
        if (localStorage.getItem('darkMode') === 'true' ||
            (!localStorage.getItem('darkMode') && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        }
    </script>
</head>

<body class="min-h-screen font-sans antialiased pb-20 bg-background text-foreground">

    <div class="max-w-4xl mx-auto px-4 sm:px-6">

        <!-- Global Header -->
        <header class="sticky top-0 z-30 glass border-b py-3 -mx-4 sm:-mx-6 px-4 sm:px-6">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <h1 class="text-xl font-bold tracking-tight flex items-center gap-2 cursor-pointer"
                        onclick="showDashboard()">
                        <span
                            class="bg-gradient-to-r from-primary to-blue-400 bg-clip-text text-transparent">Moonwave</span>
                        <span class="text-foreground">MCA</span>
                        <span class="badge bg-secondary text-secondary-foreground">v3.0</span>
                    </h1>
                </div>

                <div class="flex items-center gap-2">
                    <!-- ë‹¤í¬ ëª¨ë“œ í† ê¸€ -->
                    <button onclick="toggleDarkMode()" class="p-2 rounded-lg hover:bg-secondary transition-colors"
                        aria-label="í…Œë§ˆ ì „í™˜">
                        <svg class="w-5 h-5 hidden dark:block" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                        </svg>
                        <svg class="w-5 h-5 dark:hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                        </svg>
                    </button>

                    <!-- ë„¤ë¹„ê²Œì´ì…˜ íƒ­ -->
                    <div class="flex bg-secondary rounded-lg p-1">
                        <button id="navDash" onclick="showDashboard()"
                            class="px-3 py-1.5 rounded-md text-xs font-semibold transition-all duration-200 tab-active">
                            ëŒ€ì‹œë³´ë“œ
                        </button>
                        <button id="navDetail" onclick="showDetail()"
                            class="px-3 py-1.5 rounded-md text-xs font-semibold transition-all duration-200 tab-inactive">
                            ê°œë³„ê´€ë¦¬
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- ================= DASHBOARD VIEW ================= -->
        <div id="dashboardView" class="p-4 space-y-4 block animate-fade-in">
            <div class="card p-5">
                <div class="flex justify-between items-center mb-4 border-b border-gray-100 pb-3">
                    <h2 class="text-sm font-bold text-foreground">í†µí•© ìê¸ˆ í˜„í™©</h2>
                    <div class="flex items-center gap-2 bg-gray-50 px-2 py-1 rounded border border-gray-200">
                        <span class="text-[10px] text-muted-foreground font-bold">ì´ˆê¸° ì˜ˆìˆ˜ê¸ˆ ì„¤ì •</span>
                        <input type="text" id="initialCash" placeholder="0"
                            class="w-24 text-right text-sm font-bold bg-transparent outline-none text-foreground"
                            oninput="formatInput(this); updateDashboardStats();">
                        <span class="text-[10px] text-foreground">ì›</span>
                    </div>
                </div>
                <div class="bg-gray-800 rounded-lg p-4 text-white shadow-lg mb-4">
                    <p class="text-xs text-gray-400 mb-1">í˜„ì¬ ì‚¬ìš© ê°€ëŠ¥ í˜„ê¸ˆ (ì”ê³ )</p>
                    <div class="flex justify-between items-end">
                        <p id="dashRemainingCash" class="text-2xl font-bold text-white">0 ì›</p>
                        <p id="cashBurnRate" class="text-xs text-primary font-bold">100% ë‚¨ìŒ</p>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-1">
                        <p class="text-xs text-muted-foreground">ì´ íˆ¬ì… ê¸ˆì•¡ (ì²´ê²°)</p>
                        <p id="dashTotalInvested" class="text-lg font-bold text-foreground">0 ì›</p>
                    </div>
                    <div class="space-y-1">
                        <p class="text-xs text-muted-foreground">ë¯¸ì²´ê²° ì£¼ë¬¸ ì´ì•¡</p>
                        <p id="dashTotalOrdered" class="text-lg font-bold text-foreground">0 ì›</p>
                    </div>
                </div>
            </div>
            <div class="space-y-3" id="portfolioListContainer"></div>
            <div class="text-center pt-4">
                <button onclick="addNewPortfolio(); showDetail();"
                    class="text-xs font-bold text-gray-400 hover:text-foreground border border-dashed border-gray-300 rounded-lg w-full py-3 hover:bg-white transition">
                    + ìƒˆ ì¢…ëª© ì¶”ê°€
                </button>
            </div>
        </div>

        <!-- ================= DETAIL VIEW ================= -->
        <div id="detailView" class="hidden p-4 space-y-4">

            <!-- Portfolio Tabs -->
            <div class="flex items-center gap-2 overflow-x-auto scrollbar-hide pb-1">
                <div id="tabContainer" class="flex gap-2"></div>
                <button onclick="addNewPortfolio()"
                    class="flex-shrink-0 w-8 h-8 rounded-full bg-white border border-dashed border-gray-400 text-gray-400 flex items-center justify-center hover:bg-gray-50 hover:border-primary hover:text-foreground transition">+</button>
            </div>

            <!-- Controls -->
            <div class="card p-5 relative overflow-hidden bg-white">
                <div class="absolute top-0 left-0 w-1.5 h-full bg-success"></div>
                <div class="flex justify-between items-start mb-4">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="text-xs font-bold text-muted-foreground">ì¢…ëª©ëª…</span>
                            <input type="text" id="assetName"
                                class="font-bold text-foreground text-lg border-b border-dashed border-gray-300 focus:border-primary focus:ring-2 focus:ring-ring/20 focus:outline-none w-32 md:w-48 bg-transparent"
                                value="NAVER" onchange="updateCurrentTabName(); saveData();">
                            <button id="favoriteBtn" onclick="toggleFavorite()"
                                class="text-gray-300 hover:text-warning transition">â˜…</button>
                            <div class="h-4 w-px bg-gray-200 mx-1"></div>
                            <button onclick="deleteCurrentPortfolio()"
                                class="text-gray-300 hover:text-red-500">Ã—</button>
                        </div>
                    </div>
                </div>

                <div class="bg-gray-50 rounded-lg p-3 flex justify-between items-center border border-gray-100 mb-3">
                    <span class="text-xs font-bold text-muted-foreground">ëª©í‘œ ìš´ìš© ì˜ˆì‚°</span>
                    <div class="flex items-center gap-2">
                        <input type="text" id="targetBudgetInput" value="10,000,000"
                            class="text-right font-bold text-foreground bg-transparent focus:outline-none text-lg w-32"
                            oninput="formatInput(this)">
                        <span class="text-sm text-foreground">ì›</span>
                    </div>
                </div>
                <button onclick="autoFitParams()"
                    class="w-full py-2.5 bg-primary text-white text-sm font-bold rounded-lg shadow-sm active:bg-gray-800 transition mb-4">
                    âš¡ ì˜ˆì‚° ë§ì¶¤ ìë™ ìµœì í™”
                </button>

                <details class="group bg-white border border-gray-100 rounded-lg">
                    <summary
                        class="p-3 font-bold text-foreground cursor-pointer list-none flex justify-between items-center text-sm bg-gray-50 rounded-t-lg">
                        <span>âš™ï¸ íŒŒë¼ë¯¸í„° & ê¸°ë³´ìœ  ì„¤ì •</span>
                        <span class="text-gray-400 text-xs group-open:rotate-180 transition-transform">â–¼</span>
                    </summary>
                    <div class="p-3 grid grid-cols-2 gap-3 bg-white">
                        <div class="space-y-1">
                            <div class="param-label"><label class="text-[10px] text-muted-foreground">ê¸°ì¤€ ê³ ì </label>
                            </div><input type="text" id="peakPrice"
                                class="w-full h-9 p-2 rounded border border-gray-200 text-center font-bold text-sm focus:border-primary focus:ring-2 focus:ring-ring/20 focus:outline-none"
                                oninput="formatInput(this); handlePeakChange();">
                        </div>
                        <div class="space-y-1">
                            <div class="param-label"><label class="text-[10px] text-muted-foreground">íˆ¬ì ê°•ë„</label>
                            </div><input type="number" id="strength" step="0.01"
                                class="w-full h-9 p-2 rounded border border-gray-200 text-center font-bold text-sm focus:border-primary focus:ring-2 focus:ring-ring/20 focus:outline-none"
                                oninput="calculateMCA()">
                        </div>
                        <div class="space-y-1">
                            <div class="param-label"><label class="text-[10px] text-muted-foreground">ì‹œì‘ í•˜ë½ë¥ (%)</label>
                            </div>
                            <input type="number" id="startDrop"
                                class="w-full h-9 p-2 rounded border border-gray-200 text-center font-bold text-sm text-primary focus:border-primary focus:ring-2 focus:ring-ring/20 focus:outline-none"
                                oninput="calculateMCA()">
                        </div>
                        <div class="space-y-1">
                            <div class="param-label"><label class="text-[10px] text-muted-foreground">ë¶„í•  íšŸìˆ˜</label>
                            </div><input type="number" id="steps"
                                class="w-full h-9 p-2 rounded border border-gray-200 text-center font-bold text-sm focus:border-primary focus:ring-2 focus:ring-ring/20 focus:outline-none"
                                oninput="calculateMCA()">
                        </div>
                        <div class="col-span-2 mt-2 pt-2 border-t border-dashed border-gray-200">
                            <label class="text-xs font-bold text-gray-500 mb-2 block flex items-center gap-1"><span
                                    class="w-2 h-2 rounded-full bg-gray-400"></span> 0êµ¬ê°„ (ê¸°ì¡´ ë³´ìœ  ë¬¼ëŸ‰)</label>
                            <div class="grid grid-cols-2 gap-3">
                                <div class="space-y-1"><label class="text-[10px] text-muted-foreground">ê¸°ë³´ìœ 
                                        ìˆ˜ëŸ‰</label><input type="text" id="legacyQty" placeholder="0"
                                        class="w-full h-9 p-2 rounded bg-gray-50 border border-gray-200 text-center font-bold text-sm text-gray-600 focus:border-gray-400 focus:outline-none"
                                        oninput="formatInput(this)"></div>
                                <div class="space-y-1"><label class="text-[10px] text-muted-foreground">ê¸°ë³´ìœ 
                                        í‰ë‹¨ê°€</label><input type="text" id="legacyAvg" placeholder="0"
                                        class="w-full h-9 p-2 rounded bg-gray-50 border border-gray-200 text-center font-bold text-sm text-gray-600 focus:border-gray-400 focus:outline-none"
                                        oninput="formatInput(this)"></div>
                            </div>
                        </div>
                    </div>
                </details>
            </div>

            <!-- Detail Stats -->
            <div class="grid grid-cols-2 gap-3">
                <div class="card p-4 flex flex-col justify-between">
                    <div class="text-xs text-muted-foreground mb-1">í˜„ì¬ íˆ¬ì… ê¸ˆì•¡ (ì²´ê²°)</div>
                    <div id="currentInvested" class="text-lg font-bold text-foreground">0</div>
                    <div class="w-full bg-gray-100 rounded-full h-1.5 mt-2 overflow-hidden">
                        <div id="progressBar" class="bg-success h-full rounded-full transition-all duration-500"
                            style="width: 0%"></div>
                    </div>
                </div>
                <div class="card p-4 flex flex-col justify-between">
                    <div class="text-xs text-muted-foreground mb-1">í˜„ì¬ ë‚´ í‰ë‹¨ê°€ (í†µí•©)</div>
                    <div id="currentMyAvg" class="text-lg font-bold text-primary">0</div>
                    <div class="text-[10px] text-gray-400 mt-1 text-right">ë³´ìœ : <span id="currentMyQty"
                            class="text-foreground font-bold">0</span> ì£¼</div>
                </div>
            </div>

            <!-- Chart Card -->
            <div class="card p-4">
                <div class="flex justify-between items-end mb-2">
                    <h3 class="text-xs font-bold text-muted-foreground flex items-center gap-2"><span
                            class="w-2 h-2 rounded-full bg-success"></span> í‰ë‹¨ê°€ ë°©ì–´ì„  <span class="text-gray-300">|</span>
                        <span class="w-2 h-2 rounded-full bg-slate-400"></span> ê´´ë¦¬ìœ¨
                        ê³¡ì„ </h3>
                </div>
                <div class="h-64 relative"><canvas id="mcaChart"></canvas></div>
            </div>

            <!-- Table -->
            <div class="card overflow-hidden">
                <div
                    class="p-3 bg-gray-50 border-b border-gray-200 flex justify-between items-center sticky top-0 z-20">
                    <h3 class="text-xs font-bold text-foreground">ë§¤ë§¤ ì²´ê²° ë¦¬ìŠ¤íŠ¸</h3>
                    <div class="flex gap-2 text-[10px]">
                        <span class="flex items-center gap-1"><span
                                class="w-2 h-2 rounded-full bg-warning"></span>ì£¼ë¬¸</span>
                        <span class="flex items-center gap-1"><span
                                class="w-2 h-2 rounded-full bg-success"></span>ì²´ê²°</span>
                    </div>
                </div>
                <div class="overflow-x-auto max-h-[400px]">
                    <table class="w-full text-right text-xs whitespace-nowrap">
                        <thead class="bg-white text-muted-foreground border-b border-gray-200 sticky top-0 z-10">
                            <tr>
                                <th class="px-2 py-2 text-center bg-white w-10 text-[10px]">ì£¼ë¬¸</th>
                                <th class="px-2 py-2 text-center bg-white w-10 text-[10px]">ì²´ê²°</th>
                                <th class="px-2 py-2 text-center bg-white">êµ¬ê°„</th>
                                <th class="px-2 py-2 text-center text-primary bg-white">í•˜ë½</th>
                                <th class="px-2 py-2 text-foreground bg-white">ë§¤ìˆ˜ê°€</th>
                                <th class="px-2 py-2 bg-white">ìˆ˜ëŸ‰</th>
                                <th class="px-2 py-2 bg-white">ê¸ˆì•¡</th>
                                <th class="px-2 py-2 font-bold text-foreground bg-white border-l border-gray-100">ì´ ìˆ˜ëŸ‰
                                </th>
                                <th class="px-2 py-2 font-bold text-foreground bg-white border-l border-gray-100">ì´ ê¸ˆì•¡
                                </th>
                                <th class="px-2 py-2 text-primary bg-white">í‰ë‹¨ê°€</th>
                            </tr>
                        </thead>
                        <tbody id="resultBody" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </div>

            <!-- Exit Plan -->
            <div class="card p-4 bg-blue-50/30 border-blue-100">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-sm font-bold text-primary flex items-center gap-1">ğŸ¯ ëª©í‘œ ë§¤ë„ ì‹œë®¬ë ˆì´ì…˜</h3>
                </div>
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <div class="space-y-1"><label class="text-[10px] text-muted-foreground">120ì›”ì„  ê°€ê²©</label><input
                            type="text" id="ma120Price" placeholder="ì„ íƒ ì…ë ¥"
                            class="w-full h-9 p-2 text-center font-bold text-sm border border-gray-200 rounded focus:border-primary focus:ring-2 focus:ring-ring/20 focus:outline-none bg-white"
                            oninput="formatInput(this)"></div>
                    <div class="space-y-1"><label class="text-[10px] text-muted-foreground">ë©€í‹°í”Œ ë°°ìˆ˜ (Ã—)</label><input
                            type="number" id="targetMultiple" placeholder="ì„ íƒ ì…ë ¥" step="0.1"
                            class="w-full h-9 p-2 text-center font-bold text-sm border border-gray-200 rounded focus:border-primary focus:ring-2 focus:ring-ring/20 focus:outline-none bg-white"
                            oninput="calculateAutoTarget()"></div>
                </div>
                <div class="flex justify-between items-center bg-white p-2 rounded border border-blue-100 mb-3">
                    <span class="text-xs text-muted-foreground ml-1 whitespace-nowrap">ëª©í‘œê°€ê²©</span>
                    <input type="text" id="manualTargetPrice" placeholder="0 ì›"
                        class="text-right font-bold text-primary text-base bg-transparent focus:outline-none w-32"
                        oninput="formatInput(this)">
                </div>
                <div class="grid grid-cols-2 gap-2 text-center bg-white p-2 rounded border border-blue-100">
                    <div>
                        <div class="text-[10px] text-gray-400">ì˜ˆìƒ ìˆ˜ìµë¥ </div>
                        <div id="simRoe" class="font-bold text-destructive text-sm">-</div>
                    </div>
                    <div>
                        <div class="text-[10px] text-gray-400">ì˜ˆìƒ ìˆ˜ìµê¸ˆ</div>
                        <div id="simProfit" class="font-bold text-destructive text-sm">-</div>
                    </div>
                </div>
            </div>

            <!-- Fundamental Grade -->
            <div class="card p-4 bg-purple-50/30 border-purple-100">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-sm font-bold text-purple-600 flex items-center gap-1">ğŸ“Š Fundamental Grade</h3>
                    <div id="gradeDisplay" class="text-2xl font-bold text-purple-600">-</div>
                </div>

                <!-- ì ìˆ˜ í‘œì‹œ -->
                <div class="flex justify-between items-center bg-white p-3 rounded border border-purple-100 mb-3">
                    <span class="text-xs text-muted-foreground">ì´ì </span>
                    <div class="flex items-baseline gap-1">
                        <span id="fundamentalScore" class="text-xl font-bold text-purple-600">0</span>
                        <span class="text-xs text-gray-400">/100</span>
                    </div>
                </div>

                <!-- I. ê°€ì¹˜í‰ê°€ (35ì ) -->
                <div class="mb-3">
                    <div class="text-[10px] font-bold text-blue-600 mb-2 flex items-center gap-1">
                        <span class="w-2 h-2 rounded-full bg-blue-500"></span> I. ê°€ì¹˜í‰ê°€ (35ì )
                    </div>
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <div class="space-y-1">
                            <label class="text-[10px] text-muted-foreground">PER</label>
                            <input type="number" id="fgPer" placeholder="ì˜ˆ: 8.5" step="0.1"
                                class="w-full h-8 p-2 text-center text-sm border border-gray-200 rounded focus:border-purple-400 focus:ring-1 focus:ring-purple-200 focus:outline-none bg-white"
                                oninput="calculateFundamentalGrade()">
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] text-muted-foreground">PBR</label>
                            <input type="number" id="fgPbr" placeholder="ì˜ˆ: 0.8" step="0.1"
                                class="w-full h-8 p-2 text-center text-sm border border-gray-200 rounded focus:border-purple-400 focus:ring-1 focus:ring-purple-200 focus:outline-none bg-white"
                                oninput="calculateFundamentalGrade()">
                        </div>
                    </div>
                    <div class="flex gap-3 text-[11px]">
                        <label class="flex items-center gap-1 cursor-pointer">
                            <input type="checkbox" id="fgEarnings" class="w-3.5 h-3.5 rounded border-gray-300 text-purple-500" onchange="calculateFundamentalGrade()">
                            <span>3ë…„ ì—°ì† í‘ì</span>
                        </label>
                        <label class="flex items-center gap-1 cursor-pointer">
                            <input type="checkbox" id="fgDualListed" class="w-3.5 h-3.5 rounded border-gray-300 text-purple-500" onchange="calculateFundamentalGrade()">
                            <span>ì´ì¤‘ìƒì¥</span>
                        </label>
                    </div>
                </div>

                <!-- II. ì£¼ì£¼í™˜ì› (40ì ) -->
                <div class="mb-3">
                    <div class="text-[10px] font-bold text-green-600 mb-2 flex items-center gap-1">
                        <span class="w-2 h-2 rounded-full bg-green-500"></span> II. ì£¼ì£¼í™˜ì› (40ì )
                    </div>
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <div class="space-y-1">
                            <label class="text-[10px] text-muted-foreground">ë°°ë‹¹ìˆ˜ìµë¥  (%)</label>
                            <input type="number" id="fgDividend" placeholder="ì˜ˆ: 3.5" step="0.1"
                                class="w-full h-8 p-2 text-center text-sm border border-gray-200 rounded focus:border-purple-400 focus:ring-1 focus:ring-purple-200 focus:outline-none bg-white"
                                oninput="calculateFundamentalGrade()">
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] text-muted-foreground">ì—°ì†ë°°ë‹¹ ë…„ìˆ˜</label>
                            <input type="number" id="fgDividendYears" placeholder="ì˜ˆ: 10" min="0"
                                class="w-full h-8 p-2 text-center text-sm border border-gray-200 rounded focus:border-purple-400 focus:ring-1 focus:ring-purple-200 focus:outline-none bg-white"
                                oninput="calculateFundamentalGrade()">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <div class="space-y-1">
                            <label class="text-[10px] text-muted-foreground">ìì‚¬ì£¼ ì†Œê°ë¥  (%)</label>
                            <input type="number" id="fgBuyback" placeholder="ì˜ˆ: 1.5" step="0.1"
                                class="w-full h-8 p-2 text-center text-sm border border-gray-200 rounded focus:border-purple-400 focus:ring-1 focus:ring-purple-200 focus:outline-none bg-white"
                                oninput="calculateFundamentalGrade()">
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] text-muted-foreground">ìì‚¬ì£¼ ë¹„ìœ¨ (%)</label>
                            <input type="number" id="fgTreasury" placeholder="ì˜ˆ: 10" step="0.1"
                                class="w-full h-8 p-2 text-center text-sm border border-gray-200 rounded focus:border-purple-400 focus:ring-1 focus:ring-purple-200 focus:outline-none bg-white"
                                oninput="calculateFundamentalGrade()">
                        </div>
                    </div>
                    <div class="flex gap-3 text-[11px]">
                        <label class="flex items-center gap-1 cursor-pointer">
                            <input type="checkbox" id="fgQuarterly" class="w-3.5 h-3.5 rounded border-gray-300 text-purple-500" onchange="calculateFundamentalGrade()">
                            <span>ë¶„ê¸°ë°°ë‹¹</span>
                        </label>
                        <label class="flex items-center gap-1 cursor-pointer">
                            <input type="checkbox" id="fgBuybackProgram" class="w-3.5 h-3.5 rounded border-gray-300 text-purple-500" onchange="calculateFundamentalGrade()">
                            <span>ìì‚¬ì£¼ ë§¤ì… í”„ë¡œê·¸ë¨</span>
                        </label>
                    </div>
                </div>

                <!-- III. ì„±ì¥/ê²½ì˜ (25ì ) -->
                <div class="mb-3">
                    <div class="text-[10px] font-bold text-amber-600 mb-2 flex items-center gap-1">
                        <span class="w-2 h-2 rounded-full bg-amber-500"></span> III. ì„±ì¥/ê²½ì˜ (25ì )
                    </div>
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <div class="space-y-1">
                            <label class="text-[10px] text-muted-foreground">ì„±ì¥ ì ì¬ë ¥</label>
                            <select id="fgGrowth" class="w-full h-8 px-2 text-sm border border-gray-200 rounded focus:border-purple-400 focus:outline-none bg-white" onchange="calculateFundamentalGrade()">
                                <option value="10">ë§¤ìš° ë†’ìŒ (10ì )</option>
                                <option value="7">ë†’ìŒ (7ì )</option>
                                <option value="5" selected>ë³´í†µ (5ì )</option>
                                <option value="3">ë‚®ìŒ (3ì )</option>
                            </select>
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] text-muted-foreground">ê²½ì˜ì§„ í’ˆì§ˆ</label>
                            <select id="fgManagement" class="w-full h-8 px-2 text-sm border border-gray-200 rounded focus:border-purple-400 focus:outline-none bg-white" onchange="calculateFundamentalGrade()">
                                <option value="10">ìš°ìˆ˜ (10ì )</option>
                                <option value="5" selected>ì „ë¬¸ê²½ì˜ì¸ (5ì )</option>
                                <option value="0">ì˜¤ë„ˆë¦¬ìŠ¤í¬ (0ì )</option>
                            </select>
                        </div>
                    </div>
                    <label class="flex items-center gap-1 cursor-pointer text-[11px]">
                        <input type="checkbox" id="fgGlobalBrand" class="w-3.5 h-3.5 rounded border-gray-300 text-purple-500" onchange="calculateFundamentalGrade()">
                        <span>ê¸€ë¡œë²Œ ë¸Œëœë“œ ë³´ìœ </span>
                    </label>
                </div>

                <!-- ì ìˆ˜ ë°” -->
                <div class="space-y-1.5 bg-white p-2 rounded border border-purple-100">
                    <div class="flex items-center gap-2">
                        <span class="w-20 text-[10px] text-gray-500">ê°€ì¹˜í‰ê°€</span>
                        <div class="flex-1 h-1.5 bg-gray-100 rounded-full overflow-hidden">
                            <div id="barValuation" class="h-full bg-blue-500 rounded-full transition-all" style="width: 0%"></div>
                        </div>
                        <span id="scoreValuation" class="w-10 text-[10px] text-right font-medium">0/35</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="w-20 text-[10px] text-gray-500">ì£¼ì£¼í™˜ì›</span>
                        <div class="flex-1 h-1.5 bg-gray-100 rounded-full overflow-hidden">
                            <div id="barShareholder" class="h-full bg-green-500 rounded-full transition-all" style="width: 0%"></div>
                        </div>
                        <span id="scoreShareholder" class="w-10 text-[10px] text-right font-medium">0/40</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="w-20 text-[10px] text-gray-500">ì„±ì¥/ê²½ì˜</span>
                        <div class="flex-1 h-1.5 bg-gray-100 rounded-full overflow-hidden">
                            <div id="barGrowth" class="h-full bg-amber-500 rounded-full transition-all" style="width: 0%"></div>
                        </div>
                        <span id="scoreGrowth" class="w-10 text-[10px] text-right font-medium">0/25</span>
                    </div>
                </div>
            </div>

            <div class="flex justify-center gap-4 py-4">
                <button onclick="exportData()" class="text-xs font-bold text-primary">ğŸ’¾ ë°ì´í„° ë°±ì—…</button>
                <button onclick="triggerImport()" class="text-xs font-bold text-gray-400">ğŸ“‚ ë°ì´í„° ë³µêµ¬</button>
                <input type="file" id="fileInput2" style="display:none" onchange="importData(this)" accept=".json">
            </div>
        </div>
    </div>

    <div id="toast"
        class="fixed bottom-10 left-1/2 transform -translate-x-1/2 bg-gray-800/90 text-white px-4 py-2 rounded-full shadow-lg opacity-0 transition-opacity duration-300 pointer-events-none z-50 text-xs font-bold whitespace-nowrap">
        ì•Œë¦¼ ë©”ì‹œì§€</div>

    <script>
        const formatNum = (num) => new Intl.NumberFormat('ko-KR').format(num);
        function parseFormattedNum(str) { if (!str) return 0; return parseFloat(str.replace(/,/g, '')); }
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.innerText = message;
            toast.classList.remove('opacity-0');
            setTimeout(() => { toast.classList.add('opacity-0'); }, 2000);
        }

        // ë‹¤í¬ ëª¨ë“œ í† ê¸€
        function toggleDarkMode() {
            document.documentElement.classList.toggle('dark');
            const isDark = document.documentElement.classList.contains('dark');
            localStorage.setItem('darkMode', isDark);
            // ì°¨íŠ¸ ì—…ë°ì´íŠ¸
            if (mcaChart) {
                setTimeout(() => calculateMCA(), 100);
            }
            showToast(isDark ? 'ë‹¤í¬ ëª¨ë“œ í™œì„±í™”' : 'ë¼ì´íŠ¸ ëª¨ë“œ í™œì„±í™”');
        }

        // ë‹¤í¬ ëª¨ë“œ ê°ì§€
        function isDarkMode() {
            return document.documentElement.classList.contains('dark');
        }

        const STORAGE_KEY_V12 = 'Moonwave_MCA_v12_Data';
        let portfolios = [];
        let activePortfolioId = null;
        let initialCash = 0;
        let mcaChart = null;
        let globalCalculatedData = [];

        function showDashboard() {
            document.getElementById('dashboardView').classList.remove('hidden');
            document.getElementById('detailView').classList.add('hidden');
            document.getElementById('navDash').classList.add('tab-active');
            document.getElementById('navDash').classList.remove('tab-inactive');
            document.getElementById('navDetail').classList.remove('tab-active');
            document.getElementById('navDetail').classList.add('tab-inactive');
            updateDashboardStats();
        }

        function showDetail(portfolioId) {
            if (portfolioId) switchTab(portfolioId);
            document.getElementById('dashboardView').classList.add('hidden');
            document.getElementById('detailView').classList.remove('hidden');
            document.getElementById('navDash').classList.remove('tab-active');
            document.getElementById('navDash').classList.add('tab-inactive');
            document.getElementById('navDetail').classList.add('tab-active');
            document.getElementById('navDetail').classList.remove('tab-inactive');
            setTimeout(() => { if (!mcaChart || mcaChart.ctx) calculateMCA(); }, 50);
        }

        function calculatePortfolioStats(p) {
            const peak = parseFormattedNum(p.params.peakPrice || '0');
            const strength = parseFloat(p.params.strength || '1.0');
            const startDrop = parseFloat(p.params.startDrop || '10');
            const tick = getAutoTick(peak);
            const steps = parseInt(p.params.steps || '20');

            let executedAmt = 0; let orderedAmt = 0;
            let lastExecutedStep = 0; let lastOrderedStep = 0;
            const executedSteps = p.executedSteps || [];
            const orderedSteps = p.orderedSteps || [];

            if (executedSteps.length > 0) lastExecutedStep = Math.max(...executedSteps);
            if (orderedSteps.length > 0) lastOrderedStep = Math.max(...orderedSteps);

            for (let i = 1; i <= steps; i++) {
                const dropRate = startDrop + (i - 1);
                const rawPrice = peak * (1 - (dropRate / 100));
                const buyPrice = Math.floor(rawPrice / tick) * tick;
                let qty = Math.trunc(strength * Math.exp(i / 3));
                if (qty < 1) qty = 1;
                const amt = buyPrice * qty;
                if (executedSteps.includes(i)) executedAmt += amt;
                else if (orderedSteps.includes(i)) orderedAmt += amt;
            }
            return { executedAmt, orderedAmt, lastExecutedStep, lastOrderedStep };
        }

        function updateDashboardStats() {
            let totalExecutedAmt = 0; let totalOrderedAmt = 0;
            const container = document.getElementById('portfolioListContainer');
            container.innerHTML = '';
            const sorted = [...portfolios].sort((a, b) => (a.isFavorite === b.isFavorite) ? a.id - b.id : (a.isFavorite ? -1 : 1));

            sorted.forEach(p => {
                const stats = calculatePortfolioStats(p);
                totalExecutedAmt += stats.executedAmt;
                totalOrderedAmt += stats.orderedAmt;
                const gap = stats.lastOrderedStep - stats.lastExecutedStep;
                let statusBadge = "", statusClass = "border-gray-200";

                if (stats.lastOrderedStep > 0 && gap <= 3) {
                    statusBadge = `<span class="text-[10px] font-bold text-red-500 bg-red-50 px-2 py-0.5 rounded animate-pulse">ğŸš¨ ì¶”ê°€ ì£¼ë¬¸ í•„ìš”</span>`;
                    statusClass = "border-red-200 ring-1 ring-red-50";
                } else if (stats.lastOrderedStep === 0) {
                    statusBadge = `<span class="text-[10px] font-bold text-gray-400 bg-gray-100 px-2 py-0.5 rounded">ì£¼ë¬¸ ì—†ìŒ</span>`;
                } else {
                    statusBadge = `<span class="text-[10px] font-bold text-primary bg-green-50 px-2 py-0.5 rounded">ì •ìƒ ìš´ìš© ì¤‘</span>`;
                }

                const card = document.createElement('div');
                card.className = `card p-4 hover:shadow-md transition cursor-pointer border ${statusClass}`;
                card.onclick = () => showDetail(p.id);
                card.innerHTML = `
                    <div class="flex justify-between items-center mb-2"><h3 class="font-bold text-foreground flex items-center gap-1">${p.isFavorite ? '<span class="text-warning">â˜…</span>' : ''} ${p.name}</h3>${statusBadge}</div>
                    <div class="flex justify-between items-center text-xs text-gray-500 mb-1"><span>ì²´ê²°: <strong>${stats.lastExecutedStep}êµ¬ê°„</strong></span><span>ì£¼ë¬¸: <strong>${stats.lastOrderedStep}êµ¬ê°„</strong></span></div>
                    <div class="w-full bg-gray-100 rounded-full h-2 flex overflow-hidden">${renderBarSegments(stats.lastExecutedStep, stats.lastOrderedStep)}</div>`;
                container.appendChild(card);
            });

            const setCash = parseFormattedNum(document.getElementById('initialCash').value);
            const remainingCash = setCash - totalExecutedAmt;
            document.getElementById('dashTotalInvested').innerText = formatNum(totalExecutedAmt) + " ì›";
            document.getElementById('dashTotalOrdered').innerText = formatNum(totalOrderedAmt) + " ì›";
            document.getElementById('dashRemainingCash').innerText = formatNum(remainingCash) + " ì›";
            const burnPct = setCash > 0 ? Math.round((remainingCash / setCash) * 100) : 0;
            const burnEl = document.getElementById('cashBurnRate');
            burnEl.innerText = `${burnPct}% ë‚¨ìŒ`;
            burnEl.className = burnPct < 20 ? "text-xs font-bold text-red-400" : "text-xs font-bold text-primary";
            initialCash = setCash;
            saveData();
        }

        function renderBarSegments(exec, order) {
            const max = 20; const execW = (exec / max) * 100; const orderW = ((order - exec) / max) * 100;
            return `<div class="h-full bg-success" style="width: ${execW}%"></div><div class="h-full bg-warning" style="width: ${orderW}%"></div>`;
        }

        function getAutoTick(price) {
            if (price < 2000) return 1; if (price < 5000) return 5; if (price < 20000) return 10;
            if (price < 50000) return 50; if (price < 200000) return 100; if (price < 500000) return 500; return 1000;
        }
        function handlePeakChange() { calculateMCA(); }
        function formatInput(input) {
            let value = input.value.replace(/[^0-9]/g, '');
            if (value) value = parseInt(value).toLocaleString('ko-KR');
            input.value = value;
            if (input.id === 'ma120Price') calculateAutoTarget();
            else if (input.id === 'manualTargetPrice') calculateSimulation();
            else if (input.id === 'initialCash') updateDashboardStats();
            else calculateMCA();
        }
        function calculateAutoTarget() {
            const ma120 = parseFormattedNum(document.getElementById('ma120Price').value);
            const multiple = parseFloat(document.getElementById('targetMultiple').value);
            if (ma120 && multiple) {
                const autoTarget = Math.round(ma120 * multiple);
                document.getElementById('manualTargetPrice').value = formatNum(autoTarget);
            }
            calculateSimulation();
        }

        // ë°±ì—… ë°ì´í„° (2026-01-23)
        const BACKUP_DATA = { "portfolios": [{ "id": 1768110513446, "name": "NAVER", "params": { "peakPrice": "262,500", "strength": "0.98", "startDrop": "13.5", "steps": "20", "targetBudget": "500,000,000", "ma120Price": "212,200", "targetMultiple": "2.5", "manualTargetPrice": "", "legacyQty": "35", "legacyAvg": "243,386" }, "executedSteps": [], "orderedSteps": [1, 2, 3, 4, 5, 6], "isFavorite": true }, { "id": 1768113895078, "name": "LGì „ì", "params": { "peakPrice": "102,500", "strength": "0.6", "startDrop": "11", "steps": "19", "targetBudget": "200,000,000", "ma120Price": "89,100", "targetMultiple": "3", "manualTargetPrice": "267,300", "legacyQty": "30", "legacyAvg": "91,808" }, "orderedSteps": [1, 3, 2, 4, 5, 6, 7, 8, 9, 10], "executedSteps": [1, 3, 2, 4, 5], "isFavorite": true }, { "id": 1768114143959, "name": "ì´í¬ë ˆë”ë¸”", "params": { "peakPrice": "18,490", "strength": "5", "startDrop": "16", "steps": "20", "targetBudget": "50,000,000", "ma120Price": "", "targetMultiple": "", "manualTargetPrice": "", "legacyQty": "71", "legacyAvg": "16,960" }, "orderedSteps": [1, 2, 5, 6, 7, 4, 3], "executedSteps": [1, 2] }, { "id": 1768132674054, "name": "ì• ê²½ì‚°ì—…", "isFavorite": true, "params": { "peakPrice": "19,230", "strength": "10", "startDrop": "28", "steps": "20", "targetBudget": "50,000,000", "ma120Price": "17,000", "targetMultiple": "1", "manualTargetPrice": "17,000", "legacyQty": "122", "legacyAvg": "13,176" }, "orderedSteps": [1, 2, 3, 4, 5, 6, 7, 9, 8, 10, 11], "executedSteps": [1, 2, 3, 4, 5, 6, 7, 8] }, { "id": 1768165226034, "name": "LGì „ì", "isFavorite": false, "params": { "peakPrice": "102,500", "strength": "0.8", "startDrop": "12", "steps": "20", "targetBudget": "10,000,000", "ma120Price": "", "targetMultiple": "", "manualTargetPrice": "", "legacyQty": "33", "legacyAvg": "91,380" }, "orderedSteps": [2, 1, 5, 6, 7, 8, 9], "executedSteps": [] }, { "id": 1768222518053, "name": "ì¼€ì´ì¹´", "isFavorite": false, "params": { "peakPrice": "19,999", "strength": "5", "startDrop": "25.2", "steps": "20", "targetBudget": "50,000,000", "ma120Price": "", "targetMultiple": "", "manualTargetPrice": "", "legacyQty": "92", "legacyAvg": "15,763" }, "orderedSteps": [1, 2, 3, 4, 5], "executedSteps": [] }, { "id": 1768303417998, "name": "ê²½ë°©", "isFavorite": true, "params": { "peakPrice": "14,310", "strength": "10", "startDrop": "35.5", "steps": "20", "targetBudget": "50,000,000", "ma120Price": "", "targetMultiple": "", "manualTargetPrice": "", "legacyQty": "62", "legacyAvg": "9,225" }, "orderedSteps": [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11], "executedSteps": [1, 2, 3, 4, 5, 6, 7, 8] }, { "id": 1768303742010, "name": "ì‚¼í™”íì¸íŠ¸ ", "isFavorite": true, "params": { "peakPrice": "10,300", "strength": "10", "startDrop": "30", "steps": "20", "targetBudget": "50,000,000", "ma120Price": "", "targetMultiple": "", "manualTargetPrice": "", "legacyQty": "15", "legacyAvg": "6,950" }, "orderedSteps": [1, 2, 3, 4, 5, 6, 8, 7, 9, 10], "executedSteps": [1, 2, 3, 4, 5, 6, 7] }, { "id": 1768304238627, "name": "KZì •ë°€", "isFavorite": false, "params": { "peakPrice": "100,000", "strength": "1.0", "startDrop": "10", "steps": "20", "targetBudget": "10,000,000", "ma120Price": "", "targetMultiple": "", "manualTargetPrice": "", "legacyQty": "0", "legacyAvg": "0" }, "orderedSteps": [], "executedSteps": [] }, { "id": 1768382928364, "name": "ë¬´ë¦¼í˜ì´í¼", "isFavorite": false, "params": { "peakPrice": "2,140", "strength": "20", "startDrop": "12", "steps": "20", "targetBudget": "50,000,000", "ma120Price": "", "targetMultiple": "", "manualTargetPrice": "", "legacyQty": "329", "legacyAvg": "1,998" }, "orderedSteps": [1, 2, 3, 4, 5, 6, 7], "executedSteps": [] }, { "id": 1768384548030, "name": "HRS", "isFavorite": false, "params": { "peakPrice": "5,640", "strength": "7", "startDrop": "12", "steps": "20", "targetBudget": "50,000,000", "ma120Price": "", "targetMultiple": "", "manualTargetPrice": "", "legacyQty": "240", "legacyAvg": "5,303" }, "orderedSteps": [3, 2, 1, 4, 5, 6, 7], "executedSteps": [] }, { "id": 1768384749135, "name": "ì¢…ê·¼ë‹¹", "isFavorite": false, "params": { "peakPrice": "91,000", "strength": "1.0", "startDrop": "12.1", "steps": "20", "targetBudget": "50,000,000", "ma120Price": "", "targetMultiple": "", "manualTargetPrice": "", "legacyQty": "8", "legacyAvg": "86,175" }, "orderedSteps": [3, 2, 1, 7, 6, 5, 4], "executedSteps": [], "portfolioMemo": "ëŒ€ì„± í† ìŠ¤ê³„ì¢Œ", "executionDates": { "1": "2026-01-14" } }, { "id": 1768385382507, "name": "ë§ë„¤íŠ¸", "isFavorite": false, "params": { "peakPrice": "4,075", "strength": "10", "startDrop": "12", "steps": "20", "targetBudget": "50,000,000", "legacyQty": "59", "legacyAvg": "4,001", "ma120Price": "", "targetMultiple": "", "manualTargetPrice": "" }, "orderedSteps": [1, 2, 4, 3, 7, 6, 5], "executedSteps": [], "stepMemos": {}, "executionDates": {}, "portfolioMemo": "" }, { "id": 1768386034868, "name": "ì§„ì–‘í´ë¦¬", "isFavorite": false, "params": { "peakPrice": "3,496", "strength": "10", "startDrop": "18", "steps": "20", "targetBudget": "10,000,000", "legacyQty": "0", "legacyAvg": "0", "ma120Price": "", "targetMultiple": "", "manualTargetPrice": "" }, "orderedSteps": [1, 2, 3, 4, 5, 6, 7, 8, 9], "executedSteps": [], "stepMemos": {}, "executionDates": { "1": "2026-01-15", "2": "2026-01-15" }, "portfolioMemo": "" }, { "id": 1768386045578, "name": "SOOP", "isFavorite": false, "params": { "peakPrice": "98,500", "strength": "3", "startDrop": "30", "steps": "20", "targetBudget": "50,000,000", "legacyQty": "4", "legacyAvg": "67,400", "ma120Price": "", "targetMultiple": "", "manualTargetPrice": "" }, "orderedSteps": [6, 7, 8, 9, 4, 5, 3, 2, 1, 10], "executedSteps": [5, 4, 3, 2, 1], "stepMemos": {}, "executionDates": { "1": "2026-01-14", "2": "2026-01-14", "3": "2026-01-14", "4": "2026-01-14", "5": "2026-01-14" }, "portfolioMemo": "" }, { "id": 1768522966973, "name": "LGì”¨ì•¤ì—ìŠ¤", "isFavorite": false, "params": { "peakPrice": "76,200", "strength": "1.0", "startDrop": "12", "steps": "20", "targetBudget": "10,000,000", "legacyQty": "0", "legacyAvg": "0", "ma120Price": "", "targetMultiple": "", "manualTargetPrice": "" }, "orderedSteps": [], "executedSteps": [], "stepMemos": {}, "executionDates": {}, "portfolioMemo": "" }, { "id": 1768689829036, "name": "TEST", "isFavorite": false, "params": { "peakPrice": "270,000", "strength": "1", "startDrop": "12", "steps": "20", "targetBudget": "100,000,000", "legacyQty": "0", "legacyAvg": "0", "ma120Price": "", "targetMultiple": "", "manualTargetPrice": "" }, "orderedSteps": [], "executedSteps": [], "stepMemos": {}, "executionDates": { "1": "2026-01-17", "2": "2026-01-17", "3": "2026-01-17", "4": "2026-01-17", "5": "2026-01-17", "6": "2026-01-17", "7": "2026-01-17", "8": "2026-01-17", "9": "2026-01-17", "10": "2026-01-17", "11": "2026-01-17", "12": "2026-01-17", "13": "2026-01-17", "14": "2026-01-17", "15": "2026-01-17", "16": "2026-01-17", "17": "2026-01-17", "18": "2026-01-17", "19": "2026-01-17", "20": "2026-01-17" }, "portfolioMemo": "" }], "activeId": 1768304238627, "initialCash": 90000000 };

        function initData() {
            const saved = localStorage.getItem(STORAGE_KEY_V12);
            if (saved) {
                const parsed = JSON.parse(saved);
                portfolios = parsed.portfolios || [];
                activePortfolioId = parsed.activeId;
                initialCash = parsed.initialCash || 0;
            } else {
                // ë°±ì—… ë°ì´í„°ë¡œ ì´ˆê¸°í™”
                portfolios = BACKUP_DATA.portfolios;
                activePortfolioId = BACKUP_DATA.activeId;
                initialCash = BACKUP_DATA.initialCash;
                localStorage.setItem(STORAGE_KEY_V12, JSON.stringify(BACKUP_DATA));
            }
            if (portfolios.length === 0) addNewPortfolio(false);
            if (!activePortfolioId || !portfolios.find(p => p.id === activePortfolioId)) activePortfolioId = portfolios[0].id;
            document.getElementById('initialCash').value = formatNum(initialCash);
            renderTabs(); loadActivePortfolio(); showDashboard();
        }

        function addNewPortfolio(shouldRender = true) {
            const newId = Date.now();
            portfolios.push({
                id: newId, name: "ìƒˆ ì¢…ëª©", isFavorite: false,
                params: { peakPrice: '100,000', strength: '1.0', startDrop: '10', steps: '20', targetBudget: '10,000,000', legacyQty: '0', legacyAvg: '0', ma120Price: '', targetMultiple: '', manualTargetPrice: '' },
                orderedSteps: [], executedSteps: []
            });
            activePortfolioId = newId;
            if (shouldRender) { renderTabs(); loadActivePortfolio(); saveData(); updateDashboardStats(); showToast("ì¶”ê°€ë¨"); }
        }

        function switchTab(id) { activePortfolioId = id; renderTabs(); loadActivePortfolio(); saveData(); }
        function deleteCurrentPortfolio() {
            if (portfolios.length <= 1) { alert("ìµœì†Œ í•˜ë‚˜ í•„ìš”"); return; }
            if (confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                portfolios = portfolios.filter(p => p.id !== activePortfolioId);
                activePortfolioId = portfolios[0].id;
                renderTabs(); loadActivePortfolio(); saveData(); updateDashboardStats();
            }
        }
        function updateCurrentTabName() {
            const p = portfolios.find(p => p.id === activePortfolioId);
            if (p) { p.name = document.getElementById('assetName').value; renderTabs(); updateDashboardStats(); }
        }
        function toggleFavorite() {
            const p = portfolios.find(p => p.id === activePortfolioId);
            if (p) { p.isFavorite = !p.isFavorite; updateFavoriteUI(); renderTabs(); saveData(); updateDashboardStats(); }
        }
        function updateFavoriteUI() {
            const p = portfolios.find(p => p.id === activePortfolioId);
            const btn = document.getElementById('favoriteBtn');
            btn.className = p && p.isFavorite ? "text-warning hover:text-[#E5C158] transition" : "text-gray-300 hover:text-warning transition";
        }
        function renderTabs() {
            const container = document.getElementById('tabContainer');
            container.innerHTML = '';
            const sorted = [...portfolios].sort((a, b) => (a.isFavorite === b.isFavorite) ? a.id - b.id : (a.isFavorite ? -1 : 1));
            sorted.forEach(p => {
                const isActive = p.id === activePortfolioId;
                const div = document.createElement('div');
                div.className = `px-3 py-1.5 rounded-full text-xs font-bold cursor-pointer whitespace-nowrap transition-all border flex items-center gap-1 ${isActive ? 'tab-active' : 'tab-inactive'}`;
                div.innerHTML = `${p.isFavorite ? '<span class="text-warning">â˜…</span>' : ''}${p.name}`;
                div.onclick = () => { switchTab(p.id); showDetail(); };
                container.appendChild(div);
            });
        }
        function saveData() {
            const p = portfolios.find(p => p.id === activePortfolioId);
            if (p) {
                p.name = document.getElementById('assetName').value;
                p.params = {
                    peakPrice: document.getElementById('peakPrice').value,
                    strength: document.getElementById('strength').value,
                    startDrop: document.getElementById('startDrop').value,
                    steps: document.getElementById('steps').value,
                    targetBudget: document.getElementById('targetBudgetInput').value,
                    ma120Price: document.getElementById('ma120Price').value,
                    targetMultiple: document.getElementById('targetMultiple').value,
                    manualTargetPrice: document.getElementById('manualTargetPrice').value,
                    legacyQty: document.getElementById('legacyQty').value,
                    legacyAvg: document.getElementById('legacyAvg').value
                };
                // Fundamental Grade ë°ì´í„° ì €ì¥
                p.fundamentalData = {
                    per: parseFloat(document.getElementById('fgPer').value) || null,
                    pbr: parseFloat(document.getElementById('fgPbr').value) || null,
                    earningsSustainability: document.getElementById('fgEarnings').checked,
                    isDualListed: document.getElementById('fgDualListed').checked,
                    dividendYield: parseFloat(document.getElementById('fgDividend').value) || null,
                    consecutiveDividendYears: parseInt(document.getElementById('fgDividendYears').value) || 0,
                    hasQuarterlyDividend: document.getElementById('fgQuarterly').checked,
                    hasBuybackProgram: document.getElementById('fgBuybackProgram').checked,
                    annualCancellationRate: parseFloat(document.getElementById('fgBuyback').value) || 0,
                    treasuryStockRatio: parseFloat(document.getElementById('fgTreasury').value) || 0,
                    growthPotential: parseInt(document.getElementById('fgGrowth').value) || 5,
                    managementQuality: parseInt(document.getElementById('fgManagement').value) || 5,
                    hasGlobalBrand: document.getElementById('fgGlobalBrand').checked
                };
                const gradeResult = calculateFundamentalGrade();
                p.fundamentalScore = gradeResult.totalScore;
                p.fundamentalGrade = gradeResult.grade;
            }
            localStorage.setItem(STORAGE_KEY_V12, JSON.stringify({ portfolios: portfolios, activeId: activePortfolioId, initialCash: initialCash }));
        }

        // Fundamental Grade ê³„ì‚°
        function calculateFundamentalGrade() {
            // I. ê°€ì¹˜í‰ê°€ (35ì )
            let valuation = 0;
            const per = parseFloat(document.getElementById('fgPer').value);
            const pbr = parseFloat(document.getElementById('fgPbr').value);

            if (!isNaN(per)) {
                if (per <= 10) valuation += 10;
                else if (per <= 15) valuation += 5;
            }
            if (!isNaN(pbr)) {
                if (pbr <= 1) valuation += 10;
                else if (pbr <= 2) valuation += 5;
            }
            if (document.getElementById('fgEarnings').checked) valuation += 10;
            if (document.getElementById('fgDualListed').checked) valuation += 5;

            // II. ì£¼ì£¼í™˜ì› (40ì )
            let shareholder = 0;
            const dividend = parseFloat(document.getElementById('fgDividend').value);
            const dividendYears = parseInt(document.getElementById('fgDividendYears').value) || 0;
            const buyback = parseFloat(document.getElementById('fgBuyback').value) || 0;
            const treasury = parseFloat(document.getElementById('fgTreasury').value) || 0;

            if (!isNaN(dividend)) {
                if (dividend >= 3) shareholder += 10;
                else if (dividend >= 1) shareholder += 5;
            }
            if (document.getElementById('fgQuarterly').checked) shareholder += 5;
            if (dividendYears >= 5) shareholder += 5;
            if (document.getElementById('fgBuybackProgram').checked) shareholder += 5;
            if (buyback >= 1) shareholder += 5;
            if (treasury >= 10) shareholder += 10;
            else if (treasury >= 5) shareholder += 5;

            // III. ì„±ì¥/ê²½ì˜ (25ì )
            let growth = 0;
            growth += parseInt(document.getElementById('fgGrowth').value) || 5;
            growth += parseInt(document.getElementById('fgManagement').value) || 5;
            if (document.getElementById('fgGlobalBrand').checked) growth += 5;

            const totalScore = valuation + shareholder + growth;
            let grade = 'F';
            let gradeColor = '#ef4444';
            if (totalScore >= 90) { grade = 'S'; gradeColor = '#8b5cf6'; }
            else if (totalScore >= 80) { grade = 'A'; gradeColor = '#22c55e'; }
            else if (totalScore >= 70) { grade = 'B'; gradeColor = '#3b82f6'; }
            else if (totalScore >= 60) { grade = 'C'; gradeColor = '#f59e0b'; }
            else if (totalScore >= 50) { grade = 'D'; gradeColor = '#f97316'; }

            // UI ì—…ë°ì´íŠ¸
            document.getElementById('fundamentalScore').innerText = totalScore;
            document.getElementById('gradeDisplay').innerText = grade;
            document.getElementById('gradeDisplay').style.color = gradeColor;
            document.getElementById('fundamentalScore').style.color = gradeColor;

            document.getElementById('barValuation').style.width = (valuation / 35 * 100) + '%';
            document.getElementById('barShareholder').style.width = (shareholder / 40 * 100) + '%';
            document.getElementById('barGrowth').style.width = (growth / 25 * 100) + '%';
            document.getElementById('scoreValuation').innerText = valuation + '/35';
            document.getElementById('scoreShareholder').innerText = shareholder + '/40';
            document.getElementById('scoreGrowth').innerText = growth + '/25';

            return { totalScore, grade, valuation, shareholder, growth };
        }
        function loadActivePortfolio() {
            const p = portfolios.find(p => p.id === activePortfolioId);
            if (!p) return;
            const params = p.params || {};
            document.getElementById('assetName').value = p.name;
            document.getElementById('peakPrice').value = params.peakPrice || '100,000';
            document.getElementById('strength').value = params.strength || '1.0';
            document.getElementById('startDrop').value = params.startDrop || '10';
            document.getElementById('steps').value = params.steps || '20';
            document.getElementById('targetBudgetInput').value = params.targetBudget || '10,000,000';
            document.getElementById('ma120Price').value = params.ma120Price || '';
            document.getElementById('targetMultiple').value = params.targetMultiple || '';
            document.getElementById('manualTargetPrice').value = params.manualTargetPrice || '';
            document.getElementById('legacyQty').value = params.legacyQty || '0';
            document.getElementById('legacyAvg').value = params.legacyAvg || '0';

            // Fundamental Grade ë°ì´í„° ë¡œë“œ
            const fg = p.fundamentalData || {};
            document.getElementById('fgPer').value = fg.per || '';
            document.getElementById('fgPbr').value = fg.pbr || '';
            document.getElementById('fgEarnings').checked = fg.earningsSustainability || false;
            document.getElementById('fgDualListed').checked = fg.isDualListed || false;
            document.getElementById('fgDividend').value = fg.dividendYield || '';
            document.getElementById('fgDividendYears').value = fg.consecutiveDividendYears || '';
            document.getElementById('fgQuarterly').checked = fg.hasQuarterlyDividend || false;
            document.getElementById('fgBuybackProgram').checked = fg.hasBuybackProgram || false;
            document.getElementById('fgBuyback').value = fg.annualCancellationRate || '';
            document.getElementById('fgTreasury').value = fg.treasuryStockRatio || '';
            document.getElementById('fgGrowth').value = fg.growthPotential || '5';
            document.getElementById('fgManagement').value = fg.managementQuality || '5';
            document.getElementById('fgGlobalBrand').checked = fg.hasGlobalBrand || false;
            calculateFundamentalGrade();

            updateFavoriteUI(); calculateMCA();
        }

        function calculateMCA() {
            const p = portfolios.find(p => p.id === activePortfolioId);
            if (!p) return;
            const peak = parseFormattedNum(document.getElementById('peakPrice').value);
            const strength = parseFloat(document.getElementById('strength').value);
            const startDrop = parseFloat(document.getElementById('startDrop').value);
            const tick = getAutoTick(peak);
            const steps = parseInt(document.getElementById('steps').value);
            const legacyQty = parseFormattedNum(document.getElementById('legacyQty').value);
            const legacyAvg = parseFormattedNum(document.getElementById('legacyAvg').value);
            const legacyAmt = legacyQty * legacyAvg;
            const orderedSteps = p.orderedSteps || [];
            const executedSteps = p.executedSteps || [];

            if (!peak || !steps) return;

            const tbody = document.getElementById('resultBody');
            tbody.innerHTML = '';

            const labels = [], buyPrices = [], avgPrices = [], gaps = [];
            globalCalculatedData = [];

            let cumulativeQty = legacyQty;
            let cumulativeAmt = legacyAmt;

            if (legacyQty > 0) {
                const tr = document.createElement('tr');
                tr.className = 'bg-gray-100 text-gray-500 font-bold';
                tr.innerHTML = `<td class="px-2 py-2 text-center border-r border-gray-200">-</td><td class="px-2 py-2 text-center border-r border-gray-200"><span class="text-[10px] bg-gray-200 px-1 rounded">ë³´ìœ </span></td><td class="px-2 py-2 text-center">0</td><td class="px-2 py-2 text-center">-</td><td class="px-2 py-2">-</td><td class="px-2 py-2">${formatNum(legacyQty)}</td><td class="px-2 py-2">${formatNum(legacyAmt)}</td><td class="px-2 py-2 border-l border-gray-100 font-bold text-foreground">${formatNum(legacyQty)}</td><td class="px-2 py-2 font-bold text-foreground">${formatNum(legacyAmt)}</td><td class="px-2 py-2 font-bold text-primary">${formatNum(legacyAvg)}</td>`;
                tbody.appendChild(tr);
            }

            for (let i = 1; i <= steps; i++) {
                const dropRate = startDrop + (i - 1);
                const rawPrice = peak * (1 - (dropRate / 100));
                const buyPrice = Math.floor(rawPrice / tick) * tick;
                let qty = Math.trunc(strength * Math.exp(i / 3));
                if (qty < 1) qty = 1;
                const buyAmt = buyPrice * qty;

                const isExecuted = executedSteps.includes(i);

                if (isExecuted) {
                    cumulativeQty += qty;
                    cumulativeAmt += buyAmt;
                }

                const realAvg = cumulativeQty > 0 ? Math.round(cumulativeAmt / cumulativeQty) : 0;

                let displayTotalQty = "-";
                let displayTotalAmt = "-";
                let displayAvg = "-";

                if (isExecuted) {
                    displayTotalQty = formatNum(cumulativeQty);
                    displayTotalAmt = formatNum(cumulativeAmt);
                    displayAvg = formatNum(realAvg);
                } else {
                    displayTotalQty = `<span class="text-gray-400">${formatNum(cumulativeQty)}</span>`;
                    displayTotalAmt = `<span class="text-gray-400">${formatNum(cumulativeAmt)}</span>`;
                    displayAvg = `<span class="text-gray-400">${formatNum(realAvg)}</span>`;
                }

                labels.push(i);
                avgPrices.push(realAvg);

                const gap = realAvg > 0 ? ((buyPrice - realAvg) / realAvg * 100).toFixed(2) : 0;
                gaps.push(gap);

                const isOrdered = orderedSteps.includes(i) ? 'checked' : '';
                const isExecutedChecked = isExecuted ? 'checked' : '';
                let rowClass = isExecuted ? 'bg-green-50' : (isOrdered ? 'bg-yellow-50' : '');

                const tr = document.createElement('tr');
                tr.className = rowClass;
                tr.innerHTML = `
                    <td class="px-2 py-2 text-center border-r border-gray-100"><div class="checkbox-wrapper"><input type="checkbox" class="order-checkbox" data-type="order" data-step="${i}" ${isOrdered} onchange="updateDashboard(this)"></div></td>
                    <td class="px-2 py-2 text-center border-r border-gray-100"><div class="checkbox-wrapper"><input type="checkbox" class="exec-checkbox" data-type="exec" data-step="${i}" data-amt="${buyAmt}" data-qty="${qty}" ${isExecutedChecked} onchange="updateDashboard(this)"></div></td>
                    <td class="px-2 py-2 text-center text-muted-foreground">${i}</td>
                    <td class="px-2 py-2 text-center text-primary font-bold">-${dropRate}%</td>
                    <td class="px-2 py-2 text-foreground font-medium">${formatNum(buyPrice)}</td>
                    <td class="px-2 py-2 text-muted-foreground">${formatNum(qty)}</td>
                    <td class="px-2 py-2 text-foreground text-[11px]">${formatNum(buyAmt)}</td>
                    <td class="px-2 py-2 font-bold text-foreground border-l border-gray-100">${displayTotalQty}</td>
                    <td class="px-2 py-2 font-bold text-foreground">${displayTotalAmt}</td>
                    <td class="px-2 py-2 font-bold text-primary">${displayAvg}</td>
                `;
                tbody.appendChild(tr);
            }
            updateChart(labels, avgPrices, executedSteps, gaps);
            updateDashboard(null);
            calculateSimulation();
        }

        function updateDashboard(checkbox) {
            const p = portfolios.find(p => p.id === activePortfolioId);
            if (!p) return;
            if (checkbox) {
                const step = parseInt(checkbox.dataset.step);
                const type = checkbox.dataset.type;
                if (checkbox.checked) {
                    if (type === 'order') p.orderedSteps.push(step);
                    if (type === 'exec') { p.executedSteps.push(step); if (!p.orderedSteps.includes(step)) p.orderedSteps.push(step); }
                } else {
                    if (type === 'order') p.orderedSteps = p.orderedSteps.filter(s => s !== step);
                    if (type === 'exec') p.executedSteps = p.executedSteps.filter(s => s !== step);
                }
                saveData(); calculateMCA(); updateDashboardStats(); return;
            }
            const legacyQty = parseFormattedNum(document.getElementById('legacyQty').value);
            const legacyAvg = parseFormattedNum(document.getElementById('legacyAvg').value);
            let currentAmt = legacyQty * legacyAvg;
            let currentQty = legacyQty;
            const executedChecks = document.querySelectorAll('.exec-checkbox:checked');
            executedChecks.forEach(cb => { currentAmt += parseInt(cb.dataset.amt); currentQty += parseInt(cb.dataset.qty); });

            document.getElementById('currentInvested').innerText = formatNum(currentAmt) + " ì›";
            document.getElementById('currentMyQty').innerText = formatNum(currentQty);
            const myAvg = currentQty > 0 ? Math.round(currentAmt / currentQty) : 0;
            document.getElementById('currentMyAvg').innerText = formatNum(myAvg) + " ì›";
        }

        function updateChart(labels, avgPrices, executedSteps, gaps) {
            if (typeof Chart === 'undefined') return;
            const ctx = document.getElementById('mcaChart').getContext('2d');
            if (mcaChart) mcaChart.destroy();

            // ë‹¤í¬ ëª¨ë“œ ëŒ€ì‘ ìƒ‰ìƒ
            const dark = isDarkMode();
            const executedColor = dark ? '#fbbf24' : '#f59e0b';  // warning
            const lineColor = dark ? '#3b82f6' : '#2563eb';       // primary
            const gapColor = dark ? '#22c55e' : '#16a34a';        // success
            const textColor = dark ? '#fafafa' : '#0f172a';
            const gridColor = dark ? '#262626' : '#e2e8f0';

            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, dark ? 'rgba(34, 197, 94, 0.2)' : 'rgba(22, 163, 74, 0.2)');
            gradient.addColorStop(1, 'rgba(34, 197, 94, 0)');

            // Logic: Min/Max Gap in whole series (not dependent on check)
            const numericGaps = gaps.map(g => parseFloat(g));
            const maxGap = Math.max(...numericGaps);
            const minGap = Math.min(...numericGaps);
            const maxIdx = numericGaps.indexOf(maxGap);
            const minIdx = numericGaps.indexOf(minGap); // find first occurrence

            mcaChart = new Chart(ctx, {
                type: 'line', plugins: [ChartDataLabels],
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'í‰ë‹¨ê°€ ë°©ì–´ì„ ', data: avgPrices, yAxisID: 'y',
                            borderColor: lineColor, backgroundColor: lineColor, borderWidth: 2, pointRadius: 0, tension: 0.1, order: 2, datalabels: { display: false }
                        },
                        {
                            label: 'ê´´ë¦¬ìœ¨(Gap%)', data: gaps, yAxisID: 'y1',
                            borderColor: gapColor, borderWidth: 2, tension: 0.4, fill: true, backgroundColor: gradient,
                            pointBackgroundColor: ctx => executedSteps.includes(ctx.dataIndex + 1) ? executedColor : 'transparent',
                            pointBorderColor: ctx => executedSteps.includes(ctx.dataIndex + 1) ? '#fff' : 'transparent',
                            pointBorderWidth: 2,
                            pointRadius: ctx => executedSteps.includes(ctx.dataIndex + 1) ? 5 : 0,
                            order: 1,
                            datalabels: {
                                display: (c) => c.dataIndex === minIdx || c.dataIndex === maxIdx,
                                align: (c) => c.dataIndex === minIdx ? 'bottom' : 'top',
                                color: gapColor, font: { size: 10, weight: 'bold', family: '"Nanum Gothic"' },
                                formatter: (v) => v + '%', offset: 4
                            }
                        }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    layout: { padding: { top: 20, bottom: 20, right: 0, left: 0 } },
                    plugins: {
                        legend: {
                            display: true, position: 'bottom',
                            labels: { usePointStyle: true, color: textColor, font: { family: 'Inter' } }
                        }
                    },
                    scales: {
                        x: { display: true, grid: { display: false }, ticks: { stepSize: 2, color: textColor } },
                        y: { position: 'left', grid: { display: false }, display: true, ticks: { color: textColor } },
                        y1: { position: 'right', grid: { display: false }, display: true, ticks: { color: textColor }, title: { display: true, text: 'ìˆ˜ìµë¥ (%)', color: textColor } }
                    }
                }
            });
        }

        function autoFitParams() {
            const targetBudget = parseFormattedNum(document.getElementById('targetBudgetInput').value);
            const peak = parseFormattedNum(document.getElementById('peakPrice').value);
            const startDrop = parseFloat(document.getElementById('startDrop').value);
            const tick = getAutoTick(peak);
            let currentSteps = parseInt(document.getElementById('steps').value);
            if (!targetBudget) return;
            showToast("ìµœì í™” ì¤‘...");
            function simulate(s, st, sd) {
                let sum = 0;
                for (let i = 1; i <= s; i++) {
                    let d = sd + (i - 1);
                    let p = Math.round(peak * (1 - d / 100) / tick) * tick;
                    let q = Math.trunc(st * Math.exp(i / 3)) || 1;
                    sum += p * q;
                }
                return sum;
            }
            let low = 0.01, high = 50.0, bestStrength = 1.0;
            for (let i = 0; i < 30; i++) {
                let mid = (low + high) / 2;
                let simTotal = simulate(currentSteps, mid, startDrop);
                if (simTotal > targetBudget) high = mid; else low = mid;
                bestStrength = mid;
            }
            if (bestStrength < 0.5) {
                bestStrength = 0.5;
                for (let s = currentSteps; s >= 1; s--) {
                    if (simulate(s, bestStrength, startDrop) <= targetBudget * 1.1) { currentSteps = s; break; }
                }
            }
            document.getElementById('strength').value = bestStrength.toFixed(2);
            document.getElementById('steps').value = currentSteps;
            calculateMCA();
            showToast(`ìµœì í™”: ê°•ë„ ${bestStrength.toFixed(2)}, êµ¬ê°„ ${currentSteps}`);
        }

        function calculateSimulation() {
            const targetPrice = parseFormattedNum(document.getElementById('manualTargetPrice').value);
            const currentAmt = parseFormattedNum(document.getElementById('currentInvested').innerText.replace(' ì›', ''));
            const currentQty = parseFormattedNum(document.getElementById('currentMyQty').innerText);
            if (!currentQty || !targetPrice) {
                document.getElementById('simRoe').innerText = "-";
                document.getElementById('simProfit').innerText = "-";
                return;
            }
            const profit = (targetPrice * currentQty) - currentAmt;
            const roe = (profit / currentAmt) * 100;
            document.getElementById('simRoe').innerText = roe.toFixed(2) + "%";
            document.getElementById('simProfit').innerText = formatNum(Math.round(profit)) + " ì›";
        }

        function exportData() {
            const dataStr = localStorage.getItem(STORAGE_KEY_V12);
            if (!dataStr) { showToast("ë°ì´í„° ì—†ìŒ"); return; }
            const dateStr = new Date().toISOString().slice(0, 10);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `Moonwave_Portfolio_${dateStr}.json`;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
        }
        function triggerImport() { document.getElementById('fileInput').click(); document.getElementById('fileInput2').click(); }
        function importData(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const content = e.target.result;
                    const data = JSON.parse(content);
                    if (!data.portfolios) throw new Error("Invalid");
                    localStorage.setItem(STORAGE_KEY_V12, content);
                    initData(); showToast("ë³µêµ¬ ì™„ë£Œ");
                } catch (err) { alert("ì˜¬ë°”ë¥¸ íŒŒì¼ì´ ì•„ë‹™ë‹ˆë‹¤."); }
            };
            reader.readAsText(file);
            input.value = '';
        }

        document.addEventListener('DOMContentLoaded', () => { initData(); });
    </script>
</body>

</html>